<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>attempt at CodeMirror + in-place MathJax</title>
    <link rel="stylesheet" href="CodeMirror/lib/codemirror.css">
    <script src="CodeMirror/lib/codemirror.js"></script>
    <script src="CodeMirror/mode/markdown/markdown.js"></script>
    <script src="CodeMirror/mode/xml/xml.js"></script>
    <link rel="stylesheet" href="CodeMirror/doc/docs.css">

    <style type="text/css">
      .CodeMirror {border: 1px solid silver; border-width: 1px 2px; }
      .cm-header { font-size: 150%; font-family: arial; }
      .cm-strong { font-size: 140%; }
    </style>

    <script type="text/javascript" src="https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
          processEscapes: true
        },
      });
    </script>

    <!-- I'm a JS noob, so jQuery is my only hope of writing somewhat portable code ;-).
         Drop ".min" to get non-minified source for debugging. -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>

  </head>
  <body>
    <h1>attempt at CodeMirror + in-place MathJax</h1>

    <form><textarea id="code" name="code"># A First Level Header

**Bold** text in a normal-size paragraph.

Foo $\sum^y_z x$ bar.

## A Second Level Header

$$\sum^b_c a$$
</textarea></form>
    <script id="script">
      "use strict";

      var editor = CodeMirror.fromTextArea(document.getElementById("code"),
                                           {lineNumbers: true,
                                            lineWrapping: true,
                                            mode: "markdown"});
      var doc = editor.getDoc();

      function posLE(a, b) {
        return (a.line < b.line) || (a.line == b.line && a.ch <= b.ch);
      }

      function processMath(from, to) {
        var text = editor.getRange(from, to);
        var elem = $("<span>").text(text)[0];
        console.log("processMath", text, elem);
        MathJax.Hub.Queue(["Typeset", MathJax.Hub, elem]);
        MathJax.Hub.Queue(function() {
          // If cursor is inside formula, keep it in source form.
          // TODO: behavior during selection?
          var cursor = doc.getCursor();
          if(posLE(from, cursor) && posLE(cursor, to)) {
            return;
          }
          doc.markText(from, to, {replacedWith: elem,
                                  clearOnEnter: true});
        });
      }

      function processLine(lineHandle) {
        var text = lineHandle.text;
        var line = doc.getLineNumber(lineHandle);
        console.log(line, text);

        var inline = /\$.+\$/g; // TODO: tighten, display math
        var match;
        while((match = inline.exec(text)) != null) {
          var fromCh = match.index;
          var toCh = fromCh + match[0].length;
          processMath({line: line, ch: fromCh}, {line: line, ch: toCh});
        }
      }

      /*editor.on("renderLine", function(editor, line, element) {
        console.log("renderLine", line, element);
        window.lll = line;
      });*/

      editor.on("change", function processChange(doc, changeObj) {
        console.log("change", changeObj);
        window.ccc = changeObj;
        // TODO: changeObj.{from,to} are pre-change coordinates.
        doc.eachLine(changeObj.from.line, changeObj.to.line + 1,
                     processLine);
        if(changeObj.next) {
          processChange(changeObj.next);
        }
      });

      doc.eachLine(processLine);
    </script>
  </body>
</html>
